# Visual Architecture Flows - Complete Reference

**Comprehensive visual diagrams for the Federated Imputation Platform**

---

## ğŸ“‹ Table of Contents

1. [Authentication Flow](#authentication-flow)
2. [Job Submission Flow](#job-submission-flow)
3. [Job Processing Flow](#job-processing-flow)
4. [Credential Management Flow](#credential-management-flow)
5. [Error Handling Flow](#error-handling-flow)
6. [Complete System Architecture](#complete-system-architecture)

---

## 1. Authentication Flow

### Platform User Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   Action: Login to federated imputation platform            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ POST /api/auth/login
                     â”‚ Body: {username, password}
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Service (Port 8001)                        â”‚
â”‚                                                               â”‚
â”‚  1. Receive login request                                    â”‚
â”‚  2. Query database: SELECT * FROM users WHERE username=?     â”‚
â”‚  3. Verify password: bcrypt.verify(input, stored_hash)       â”‚
â”‚  4. Generate JWT token                                       â”‚
â”‚     - Payload: {user_id, username, exp}                      â”‚
â”‚     - Sign with JWT_SECRET                                   â”‚
â”‚  5. Update last_login timestamp                              â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    access_token: "eyJhbGc...",                               â”‚
â”‚    token_type: "bearer",                                     â”‚
â”‚    expires_in: 86400,                                        â”‚
â”‚    user: {...}                                               â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Return JWT token
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   Stores: localStorage.setItem('token', jwt)                â”‚
â”‚   Uses: Authorization: Bearer {jwt} in all API calls        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Credential Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   Has: Platform JWT token                                    â”‚
â”‚   Needs: Configure H3Africa credentials                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 1. Get H3Africa API Token
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              External Service (H3Africa)                     â”‚
â”‚           https://impute.afrigen-d.org                       â”‚
â”‚                                                               â”‚
â”‚  User Actions:                                               â”‚
â”‚  1. Register account                                         â”‚
â”‚  2. Navigate to Settings â†’ API Tokens                        â”‚
â”‚  3. Click "Generate New Token"                               â”‚
â”‚  4. Copy token (shown once!)                                 â”‚
â”‚                                                               â”‚
â”‚  Returns: "h3a_abc123def456..."                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 2. Configure in Platform
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   POST /users/me/service-credentials                         â”‚
â”‚   Headers: Authorization: Bearer {platform_jwt}              â”‚
â”‚   Body: {                                                    â”‚
â”‚     service_id: 1,                                           â”‚
â”‚     api_token: "h3a_abc123def456...",                        â”‚
â”‚     label: "My H3Africa Account"                             â”‚
â”‚   }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Service (Port 8001)                        â”‚
â”‚                                                               â”‚
â”‚  1. Validate JWT token                                       â”‚
â”‚  2. Extract user_id from token                               â”‚
â”‚  3. Check existing credential:                               â”‚
â”‚     SELECT * FROM user_service_credentials                   â”‚
â”‚     WHERE user_id=? AND service_id=?                         â”‚
â”‚                                                               â”‚
â”‚  4. If exists: UPDATE                                        â”‚
â”‚     If new: INSERT                                           â”‚
â”‚                                                               â”‚
â”‚  5. Store encrypted:                                         â”‚
â”‚     INSERT INTO user_service_credentials (                   â”‚
â”‚       user_id, service_id, api_token,                        â”‚
â”‚       credential_type, is_active, created_at                 â”‚
â”‚     ) VALUES (?, ?, ?, 'api_token', true, NOW())             â”‚
â”‚                                                               â”‚
â”‚  6. Create audit log                                         â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    id: 42,                                                   â”‚
â”‚    service_id: 1,                                            â”‚
â”‚    is_verified: false,                                       â”‚
â”‚    has_api_token: true                                       â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 3. Credential stored successfully
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   Status: Ready to submit jobs âœ…                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Job Submission Flow

### Complete Job Submission Sequence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User                                  â”‚
â”‚   Has: Platform JWT + Configured H3Africa credentials       â”‚
â”‚   Action: Submit imputation job                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ POST /jobs (multipart/form-data)
                     â”‚ Headers: Authorization: Bearer {jwt}
                     â”‚ Form Data:
                     â”‚   - name: "My Job"
                     â”‚   - service_id: 1
                     â”‚   - reference_panel_id: 1
                     â”‚   - input_file: test.vcf.gz
                     â”‚   - build: hg38
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Job Processor Service (Port 8003)                  â”‚
â”‚                                                               â”‚
â”‚  STEP 1: Validate JWT                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚  - Decode JWT token                                          â”‚
â”‚  - Verify signature                                          â”‚
â”‚  - Check expiration                                          â”‚
â”‚  - Extract user_id                                           â”‚
â”‚                                                               â”‚
â”‚  STEP 2: Validate Credentials âœ… CRITICAL                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  GET http://user-service:8001/internal/users/{user_id}/     â”‚
â”‚      service-credentials/{service_id}                        â”‚
â”‚                                                               â”‚
â”‚  If no credentials:                                          â”‚
â”‚    â†’ Return 400 Bad Request                                  â”‚
â”‚    â†’ Message: "Configure your API credentials in Settings"   â”‚
â”‚    â†’ STOP processing                                         â”‚
â”‚                                                               â”‚
â”‚  If credentials exist:                                       â”‚
â”‚    â†’ Continue to next step                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Credentials validated âœ…
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Job Processor Service (Port 8003)                  â”‚
â”‚                                                               â”‚
â”‚  STEP 3: Create Job Record                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  INSERT INTO imputation_jobs (                               â”‚
â”‚    user_id, name, service_id, reference_panel_id,            â”‚
â”‚    input_format, build, phasing, status                      â”‚
â”‚  ) VALUES (                                                   â”‚
â”‚    {user_id}, 'My Job', 1, 1,                                â”‚
â”‚    'vcf', 'hg38', true, 'pending'                            â”‚
â”‚  )                                                            â”‚
â”‚  RETURNING id â†’ job_id: uuid                                 â”‚
â”‚                                                               â”‚
â”‚  STEP 4: Upload File to File Manager                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  POST http://file-manager:8004/files/upload                  â”‚
â”‚  - Multipart: file data                                      â”‚
â”‚  - Metadata: {job_id, file_type: 'input'}                    â”‚
â”‚  - Returns: {file_id, file_url}                              â”‚
â”‚                                                               â”‚
â”‚  STEP 5: Update Job with File Info                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  UPDATE imputation_jobs                                      â”‚
â”‚  SET input_file_id = {file_id}                               â”‚
â”‚  WHERE id = {job_id}                                         â”‚
â”‚                                                               â”‚
â”‚  STEP 6: Queue for Processing                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  celery.send_task('worker.process_job', args=[job_id])       â”‚
â”‚  â†’ Job queued in Redis                                       â”‚
â”‚                                                               â”‚
â”‚  STEP 7: Update Status                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚  UPDATE imputation_jobs                                      â”‚
â”‚  SET status = 'queued'                                       â”‚
â”‚  WHERE id = {job_id}                                         â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    id: job_id,                                               â”‚
â”‚    status: "queued",                                         â”‚
â”‚    progress_percentage: 0,                                   â”‚
â”‚    created_at: "2025-10-04T10:00:00Z"                        â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Job created and queued
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Redis Queue                                â”‚
â”‚   Queue: celery                                              â”‚
â”‚   Task: worker.process_job(job_id)                           â”‚
â”‚   Status: Waiting for worker...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Worker picks up task
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Celery Worker                              â”‚
â”‚   Status: Processing job_id                                  â”‚
â”‚   â†’ See "Job Processing Flow" below                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Job Processing Flow

### Worker Job Execution (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Celery Worker (Background)                      â”‚
â”‚   Task: process_job(job_id)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 1: INITIALIZATION
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Load Job Details                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  SELECT * FROM imputation_jobs WHERE id = {job_id}          â”‚
â”‚  Extract: user_id, service_id, reference_panel_id,          â”‚
â”‚           input_file_id, build, phasing, population         â”‚
â”‚                                                               â”‚
â”‚  Step 2: Update Status â†’ Running                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  UPDATE imputation_jobs                                      â”‚
â”‚  SET status = 'running',                                     â”‚
â”‚      started_at = NOW(),                                     â”‚
â”‚      progress_percentage = 0                                 â”‚
â”‚  WHERE id = {job_id}                                         â”‚
â”‚                                                               â”‚
â”‚  INSERT INTO job_status_updates (                            â”‚
â”‚    job_id, status, message                                   â”‚
â”‚  ) VALUES (                                                   â”‚
â”‚    {job_id}, 'running', 'Job processing started'            â”‚
â”‚  )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 2: GATHER RESOURCES
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Get Service Information                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  GET http://service-registry:8002/services/{service_id}     â”‚
â”‚                                                               â”‚
â”‚  Returns: {                                                  â”‚
â”‚    id: 1,                                                    â”‚
â”‚    name: "H3Africa",                                         â”‚
â”‚    api_type: "michigan",                                     â”‚
â”‚    base_url: "https://impute.afrigen-d.org",                â”‚
â”‚    supported_builds: ["hg19", "hg38"]                        â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  Step 4: Get Input File URL                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  GET http://file-manager:8004/files/{input_file_id}/        â”‚
â”‚      download                                                â”‚
â”‚                                                               â”‚
â”‚  Returns: {                                                  â”‚
â”‚    download_url: "http://file-manager:8004/files/           â”‚
â”‚                   download/{signed_token}"                   â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  Step 5: Fetch USER's Credentials âœ… CRITICAL               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  GET http://user-service:8001/internal/users/{user_id}/     â”‚
â”‚      service-credentials/{service_id}                        â”‚
â”‚                                                               â”‚
â”‚  If no credentials:                                          â”‚
â”‚    â†’ Update job: status = 'failed'                           â”‚
â”‚    â†’ Error: "No credentials configured"                      â”‚
â”‚    â†’ STOP processing                                         â”‚
â”‚                                                               â”‚
â”‚  Returns: {                                                  â”‚
â”‚    has_credential: true,                                     â”‚
â”‚    api_token: "h3a_abc123...",  â† USER'S TOKEN              â”‚
â”‚    is_verified: true                                         â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 3: EXTERNAL SUBMISSION
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: Download Input File                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  GET {download_url}                                          â”‚
â”‚  â†’ Receive file content (bytes)                              â”‚
â”‚  â†’ File size: e.g., 2.5 MB                                   â”‚
â”‚                                                               â”‚
â”‚  Step 7: Submit to H3Africa âœ… WITH USER'S TOKEN            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  POST https://impute.afrigen-d.org/api/v2/jobs/submit       â”‚
â”‚                                                               â”‚
â”‚  Headers:                                                    â”‚
â”‚    X-Auth-Token: {user's_api_token}  â† USER'S CREDENTIALS   â”‚
â”‚    Content-Type: multipart/form-data                         â”‚
â”‚                                                               â”‚
â”‚  Form Data:                                                  â”‚
â”‚    input-files: (file_content, filename.vcf.gz)              â”‚
â”‚    refpanel: "h3africa"                                      â”‚
â”‚    build: "hg38"                                             â”‚
â”‚    phasing: "eagle"                                          â”‚
â”‚    population: "AFR"                                         â”‚
â”‚    mode: "imputation"                                        â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    id: "job-20251004-xyz789",  â† External job ID             â”‚
â”‚    status: "waiting",                                        â”‚
â”‚    message: "Job queued successfully"                        â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  Step 8: Save External Job ID                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  UPDATE imputation_jobs                                      â”‚
â”‚  SET external_job_id = "job-20251004-xyz789",                â”‚
â”‚      progress_percentage = 10                                â”‚
â”‚  WHERE id = {job_id}                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 4: MONITOR PROGRESS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 9: Poll H3Africa Status (every 30 seconds)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  Loop: max_checks = 720 (6 hours timeout)                   â”‚
â”‚                                                               â”‚
â”‚  Every 30 seconds:                                           â”‚
â”‚    GET https://impute.afrigen-d.org/api/v2/jobs/             â”‚
â”‚        {external_job_id}/status                              â”‚
â”‚    Headers: X-Auth-Token: {user's_api_token}                â”‚
â”‚                                                               â”‚
â”‚    Response: {                                               â”‚
â”‚      state: "running",  // waiting â†’ running â†’ success      â”‚
â”‚      progress: 75,                                           â”‚
â”‚      message: "Phasing chromosomes..."                       â”‚
â”‚    }                                                          â”‚
â”‚                                                               â”‚
â”‚    Map status:                                               â”‚
â”‚      waiting  â†’ queued                                       â”‚
â”‚      running  â†’ running                                      â”‚
â”‚      success  â†’ completed                                    â”‚
â”‚      error    â†’ failed                                       â”‚
â”‚                                                               â”‚
â”‚    Update our database:                                      â”‚
â”‚      UPDATE imputation_jobs                                  â”‚
â”‚      SET status = {mapped_status},                           â”‚
â”‚          progress_percentage = {calculated}                  â”‚
â”‚                                                               â”‚
â”‚    If status = 'success': Break loop and proceed             â”‚
â”‚    If status = 'error': Break loop and mark failed           â”‚
â”‚    Otherwise: Continue polling                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 5: RETRIEVE RESULTS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 10: Download Results from H3Africa                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  GET https://impute.afrigen-d.org/api/v2/jobs/               â”‚
â”‚      {external_job_id}/results                               â”‚
â”‚  Headers: X-Auth-Token: {user's_api_token}                  â”‚
â”‚                                                               â”‚
â”‚  Response: ZIP file containing:                              â”‚
â”‚    - imputed.vcf.gz (imputed genotypes)                      â”‚
â”‚    - imputed.vcf.gz.tbi (index)                              â”‚
â”‚    - statistics.txt (QC metrics)                             â”‚
â”‚    - log.txt (processing log)                                â”‚
â”‚                                                               â”‚
â”‚  File size: e.g., 15 MB                                      â”‚
â”‚                                                               â”‚
â”‚  Step 11: Upload Results to File Manager                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  POST http://file-manager:8004/files/upload                  â”‚
â”‚  Files: {file: (results.zip, result_bytes)}                  â”‚
â”‚  Data: {job_id, file_type: 'output'}                         â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    id: {results_file_id},                                    â”‚
â”‚    filename: "results.zip",                                  â”‚
â”‚    file_size: 15728640                                       â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  Step 12: Update Job with Results                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  UPDATE imputation_jobs                                      â”‚
â”‚  SET results_file_id = {results_file_id},                    â”‚
â”‚      status = 'completed',                                   â”‚
â”‚      progress_percentage = 100,                              â”‚
â”‚      completed_at = NOW()                                    â”‚
â”‚  WHERE id = {job_id}                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PHASE 6: NOTIFICATION
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 13: Send Completion Notification                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  POST http://notification:8005/notifications                 â”‚
â”‚  Body: {                                                     â”‚
â”‚    user_id: {user_id},                                       â”‚
â”‚    type: "job_completed",                                    â”‚
â”‚    title: "Job Completed",                                   â”‚
â”‚    message: "Your job 'My Job' completed successfully",      â”‚
â”‚    data: {job_id, job_name, results_url},                    â”‚
â”‚    channels: ["web", "email"]                                â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  â†’ Email sent to user                                        â”‚
â”‚  â†’ Web notification created                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     âœ… JOB COMPLETE
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Final State                                â”‚
â”‚                                                               â”‚
â”‚  Database:                                                   â”‚
â”‚    - Job status: completed                                   â”‚
â”‚    - Progress: 100%                                          â”‚
â”‚    - Results file: stored in file-manager                    â”‚
â”‚    - Execution time: tracked                                 â”‚
â”‚                                                               â”‚
â”‚  User notified via:                                          â”‚
â”‚    - Email âœ…                                                â”‚
â”‚    - Web notification âœ…                                     â”‚
â”‚                                                               â”‚
â”‚  User can now:                                               â”‚
â”‚    - Download results                                        â”‚
â”‚    - View QC statistics                                      â”‚
â”‚    - Submit new jobs                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Credential Management Flow

### Adding Service Credentials

```
USER JOURNEY: First-Time Credential Setup
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: User Realizes Need for Credentials                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚  Scenario A: During job submission                          â”‚
â”‚    â†’ Tries to submit job                                     â”‚
â”‚    â†’ Gets 400 error: "No credentials configured"            â”‚
â”‚    â†’ Directed to Settings â†’ Service Credentials             â”‚
â”‚                                                               â”‚
â”‚  Scenario B: Proactive setup                                â”‚
â”‚    â†’ Navigates to Settings                                   â”‚
â”‚    â†’ Sees "Service Credentials" section                      â”‚
â”‚    â†’ Clicks "Add Credentials"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Get H3Africa Account & Token                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  1. Visit https://impute.afrigen-d.org/                      â”‚
â”‚  2. Click "Register" or "Sign In"                            â”‚
â”‚  3. Complete registration form                               â”‚
â”‚  4. Verify email                                             â”‚
â”‚  5. Login to H3Africa                                        â”‚
â”‚  6. Navigate: Settings â†’ API Tokens                          â”‚
â”‚  7. Click "Generate New Token"                               â”‚
â”‚  8. Copy token: "h3a_1a2b3c4d5e6f..."                        â”‚
â”‚     âš ï¸  Token shown only once!                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Return to Platform and Configure                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  Frontend UI (React):                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Add Service Credentials                â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  Service: [H3Africa â–¼]                  â”‚                â”‚
â”‚  â”‚  Label: [My H3Africa Account___]        â”‚                â”‚
â”‚  â”‚  API Token: [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]        â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  [Test Connection] [Save Credentials]   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  On "Save Credentials" click:                                â”‚
â”‚    â†’ Validates token format                                  â”‚
â”‚    â†’ Shows loading spinner                                   â”‚
â”‚    â†’ Makes API call                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ POST /users/me/service-credentials
                     â”‚ Headers: Authorization: Bearer {jwt}
                     â”‚ Body: {service_id, api_token, label}
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Service (Port 8001)                        â”‚
â”‚                                                               â”‚
â”‚  Validation:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  1. JWT valid? â†’ Extract user_id                             â”‚
â”‚  2. Service exists? â†’ Query service_registry                 â”‚
â”‚  3. Token format valid? â†’ Regex check                        â”‚
â”‚                                                               â”‚
â”‚  Storage:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  1. Check existing:                                          â”‚
â”‚     SELECT * FROM user_service_credentials                   â”‚
â”‚     WHERE user_id={user_id} AND service_id={service_id}      â”‚
â”‚                                                               â”‚
â”‚  2. If exists:                                               â”‚
â”‚     UPDATE user_service_credentials                          â”‚
â”‚     SET api_token={token}, updated_at=NOW(),                 â”‚
â”‚         is_verified=false  â† Reset verification              â”‚
â”‚                                                               â”‚
â”‚  3. If new:                                                  â”‚
â”‚     INSERT INTO user_service_credentials (                   â”‚
â”‚       user_id, service_id, api_token,                        â”‚
â”‚       credential_type, label, is_active                      â”‚
â”‚     ) VALUES ({user_id}, {service_id}, {token},              â”‚
â”‚               'api_token', {label}, true)                    â”‚
â”‚                                                               â”‚
â”‚  4. Audit log:                                               â”‚
â”‚     INSERT INTO audit_logs (                                 â”‚
â”‚       user_id, action, resource_type,                        â”‚
â”‚       details, timestamp                                     â”‚
â”‚     ) VALUES ({user_id}, 'create_credential',                â”‚
â”‚               'service_credential',                          â”‚
â”‚               'Service: H3Africa', NOW())                    â”‚
â”‚                                                               â”‚
â”‚  Response: {                                                 â”‚
â”‚    id: 42,                                                   â”‚
â”‚    service_id: 1,                                            â”‚
â”‚    label: "My H3Africa Account",                             â”‚
â”‚    is_verified: false,                                       â”‚
â”‚    has_api_token: true,                                      â”‚
â”‚    created_at: "2025-10-04T10:30:00Z"                        â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Success response
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Frontend UI                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  âœ… Credentials Saved Successfully!      â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  Service: H3Africa                       â”‚                â”‚
â”‚  â”‚  Label: My H3Africa Account              â”‚                â”‚
â”‚  â”‚  Status: âš ï¸  Unverified                  â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  [Test Connection Now]                   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  User can now:                                               â”‚
â”‚  - Submit jobs âœ…                                            â”‚
â”‚  - Test credentials (optional)                               â”‚
â”‚  - View/edit/delete credentials                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Error Handling Flow

### Missing Credentials Error

```
ERROR SCENARIO: User tries to submit job without credentials
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User                Job Processor           User Service
  â”‚                       â”‚                       â”‚
  â”‚ POST /jobs            â”‚                       â”‚
  â”‚ service_id=1          â”‚                       â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”‚                       â”‚                       â”‚
  â”‚                       â”‚ Check credentials     â”‚
  â”‚                       â”‚ GET /internal/users/  â”‚
  â”‚                       â”‚ {user_id}/service-    â”‚
  â”‚                       â”‚ credentials/{svc_id}  â”‚
  â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                       â”‚
  â”‚                       â”‚ {has_credential:false}â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                       â”‚
  â”‚ 400 Bad Request       â”‚                       â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
  â”‚ {                     â”‚                       â”‚
  â”‚   error: "No creds",  â”‚                       â”‚
  â”‚   message: "You must  â”‚                       â”‚
  â”‚     configure...",    â”‚                       â”‚
  â”‚   action: "Go to      â”‚                       â”‚
  â”‚     Settings...",     â”‚                       â”‚
  â”‚   service_id: 1       â”‚                       â”‚
  â”‚ }                     â”‚                       â”‚
  â”‚                       â”‚                       â”‚
  â†“                       â”‚                       â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Shows User-Friendly Error:    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  âš ï¸  Setup Required              â”‚    â”‚
â”‚  â”‚                                  â”‚    â”‚
â”‚  â”‚  You need to configure your      â”‚    â”‚
â”‚  â”‚  H3Africa API credentials        â”‚    â”‚
â”‚  â”‚  before submitting jobs.         â”‚    â”‚
â”‚  â”‚                                  â”‚    â”‚
â”‚  â”‚  [Configure Credentials]         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚  On click â†’ Redirects to:                â”‚
â”‚  /settings/service-credentials           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Invalid Credentials Error

```
ERROR SCENARIO: User's H3Africa token is invalid/expired
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Worker                  H3Africa              Job Database
  â”‚                         â”‚                       â”‚
  â”‚ POST /api/v2/jobs/      â”‚                       â”‚
  â”‚ submit                  â”‚                       â”‚
  â”‚ X-Auth-Token: {token}   â”‚                       â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”‚                         â”‚                       â”‚
  â”‚ 401 Unauthorized        â”‚                       â”‚
  â”‚ {error: "Invalid token"}â”‚                       â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
  â”‚                         â”‚                       â”‚
  â”‚ Update job: failed      â”‚                       â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚ SET status='failed'     â”‚                       â”‚
  â”‚ SET error_message=      â”‚                       â”‚
  â”‚   "H3Africa auth failed"â”‚                       â”‚
  â”‚                         â”‚                       â”‚
  â†“                         â”‚                       â”‚

User receives notification:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Job Failed                           â”‚
â”‚                                          â”‚
â”‚  Your job failed due to authentication   â”‚
â”‚  error with H3Africa.                    â”‚
â”‚                                          â”‚
â”‚  Error: Invalid API token                â”‚
â”‚                                          â”‚
â”‚  Action: Please update your credentials  â”‚
â”‚  at Settings â†’ Service Credentials       â”‚
â”‚                                          â”‚
â”‚  [Update Credentials]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Complete System Architecture

### High-Level Component Diagram

```
                        FEDERATED IMPUTATION PLATFORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    React Application (Port 3000)                  â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  Pages:                         Components:                       â”‚   â”‚
â”‚  â”‚  - Dashboard                    - ServiceCredentials              â”‚   â”‚
â”‚  â”‚  - Jobs                         - JobSubmission                   â”‚   â”‚
â”‚  â”‚  - Services                     - JobMonitor                      â”‚   â”‚
â”‚  â”‚  - Settings                     - ResultsDownload                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ HTTPS/REST API
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       API GATEWAY (Port 8000)                            â”‚
â”‚  - Request routing                                                       â”‚
â”‚  - JWT validation                                                        â”‚
â”‚  - Rate limiting                                                         â”‚
â”‚  - CORS handling                                                         â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚         â”‚            â”‚              â”‚               â”‚
  â”‚         â”‚            â”‚              â”‚               â”‚
  â†“         â†“            â†“              â†“               â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MICROSERVICES LAYER                              â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ User Service â”‚  â”‚   Service    â”‚  â”‚     Job      â”‚  â”‚    File    â”‚  â”‚
â”‚  â”‚  (Port 8001) â”‚  â”‚   Registry   â”‚  â”‚  Processor   â”‚  â”‚  Manager   â”‚  â”‚
â”‚  â”‚              â”‚  â”‚  (Port 8002) â”‚  â”‚  (Port 8003) â”‚  â”‚(Port 8004) â”‚  â”‚
â”‚  â”‚ - Auth       â”‚  â”‚              â”‚  â”‚              â”‚  â”‚            â”‚  â”‚
â”‚  â”‚ - Users      â”‚  â”‚ - Services   â”‚  â”‚ - Jobs       â”‚  â”‚ - Upload   â”‚  â”‚
â”‚  â”‚ - Profiles   â”‚  â”‚ - Panels     â”‚  â”‚ - Status     â”‚  â”‚ - Download â”‚  â”‚
â”‚  â”‚ - Credentialsâ”‚  â”‚ - Health     â”‚  â”‚ - Workers    â”‚  â”‚ - Storage  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚Notification  â”‚  â”‚  Monitoring  â”‚                                     â”‚
â”‚  â”‚  (Port 8005) â”‚  â”‚  (Port 8006) â”‚                                     â”‚
â”‚  â”‚              â”‚  â”‚              â”‚                                     â”‚
â”‚  â”‚ - Email      â”‚  â”‚ - Metrics    â”‚                                     â”‚
â”‚  â”‚ - Web alerts â”‚  â”‚ - Logs       â”‚                                     â”‚
â”‚  â”‚ - SMS (TODO) â”‚  â”‚ - Health     â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INFRASTRUCTURE LAYER                              â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    PostgreSQL        â”‚  â”‚      Redis       â”‚  â”‚     Celery       â”‚  â”‚
â”‚  â”‚    (Port 5432)       â”‚  â”‚   (Port 6379)    â”‚  â”‚    Workers       â”‚  â”‚
â”‚  â”‚                      â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ Databases:           â”‚  â”‚ - Job queue      â”‚  â”‚ - process_job    â”‚  â”‚
â”‚  â”‚ - user_management_db â”‚  â”‚ - Cache          â”‚  â”‚ - cancel_job     â”‚  â”‚
â”‚  â”‚ - service_registry_dbâ”‚  â”‚ - Sessions       â”‚  â”‚ - monitor_job    â”‚  â”‚
â”‚  â”‚ - job_processing_db  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ - file_management_db â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXTERNAL SERVICES                                   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    H3Africa          â”‚  â”‚     Michigan     â”‚  â”‚     ILIFU        â”‚  â”‚
â”‚  â”‚  Imputation Server   â”‚  â”‚  Imputation Srv  â”‚  â”‚   GA4GH WES      â”‚  â”‚
â”‚  â”‚                      â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ API: Michigan v2     â”‚  â”‚ API: Michigan v2 â”‚  â”‚ API: GA4GH WES   â”‚  â”‚
â”‚  â”‚ Auth: X-Auth-Token   â”‚  â”‚ Auth: X-Auth-Tokenâ”‚  â”‚ Auth: Bearer    â”‚  â”‚
â”‚  â”‚ URL: impute.afrigen  â”‚  â”‚ URL: imputations-â”‚  â”‚ URL: ga4gh-start â”‚  â”‚
â”‚  â”‚      -d.org          â”‚  â”‚      erver.sph...â”‚  â”‚      er-kit...   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  âœ… Per-User Authentication: Each user uses their own credentials        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Complete Request Cycle

```
COMPLETE REQUEST CYCLE: Job Submission to Results Download
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. USER AUTHENTICATION
   User â†’ Frontend â†’ User Service
   - Login with username/password
   - Receive JWT token
   - Store in localStorage

2. CREDENTIAL CONFIGURATION (One-time)
   User â†’ Frontend â†’ User Service â†’ Database
   - User provides H3Africa API token
   - Stored in user_service_credentials table
   - Linked to user_id + service_id

3. JOB SUBMISSION
   User â†’ Frontend â†’ Job Processor â†’ User Service (validate creds)
   - Check user has credentials âœ…
   - Create job record
   - Upload file to File Manager
   - Queue job in Redis

4. JOB PROCESSING
   Celery Worker â†’ User Service â†’ File Manager â†’ H3Africa
   - Fetch user's credentials âœ…
   - Download input file
   - Submit to H3Africa with user's token âœ…
   - Poll status every 30s
   - Download results when complete
   - Upload results to File Manager

5. NOTIFICATION
   Worker â†’ Notification Service â†’ User
   - Email notification sent
   - Web notification created
   - User alerted of completion

6. RESULTS DOWNLOAD
   User â†’ Frontend â†’ Job Processor â†’ File Manager
   - Request results URL
   - Download ZIP file
   - Extract imputed genotypes
```

---

## Summary

This document provides comprehensive visual flows for:

âœ… **Authentication**: Platform login + service credentials
âœ… **Job Submission**: Complete validation and queueing flow
âœ… **Job Processing**: Detailed worker execution with per-user credentials
âœ… **Credential Management**: User journey for setup
âœ… **Error Handling**: Common failure scenarios and resolution
âœ… **System Architecture**: High-level component diagram

**Key Design Principle**: Per-user service credentials ensure proper resource tracking, security isolation, and compliance with external service terms.

---

**Last Updated**: October 4, 2025
**Status**: Production Architecture
